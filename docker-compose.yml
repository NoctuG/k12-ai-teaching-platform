version: "3.9"

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: mysql://k12:k12pass@mysql:3306/k12_platform
      JWT_SECRET: change-this-in-production
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      LLM_BASE_URL: ${LLM_BASE_URL:-https://generativelanguage.googleapis.com/v1beta/openai}
      LLM_MODEL: ${LLM_MODEL:-gemini-2.5-flash}
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
      AWS_S3_BUCKET: k12-assets
      AWS_REGION: us-east-1
      S3_ENDPOINT: http://minio:9000
      S3_FORCE_PATH_STYLE: "true"
      S3_PUBLIC_BASE_URL: http://localhost:9000/k12-assets
      AUTH_PROVIDERS: local,github
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID:-}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET:-}
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
    depends_on:
      - mysql
      - minio

  mysql:
    image: mysql:8.4
    environment:
      MYSQL_DATABASE: k12_platform
      MYSQL_USER: k12
      MYSQL_PASSWORD: k12pass
      MYSQL_ROOT_PASSWORD: rootpass
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"

volumes:
  mysql_data:
  minio_data:
